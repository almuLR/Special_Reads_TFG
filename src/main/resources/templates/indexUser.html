<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Special Reads</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="/css/vendors/feather/feather.css">
  <link rel="stylesheet" href="/css/vendors/ti-icons/css/themify-icons.css">
  <link rel="stylesheet" href="/css/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="/css/vendors/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/vendors/mdi/css/materialdesignicons.min.css">

  <!-- inject:css -->
  <link rel="stylesheet" href="/css/styleIndexUser.css">
  <!-- endinject -->
  <link rel="shortcut icon" href="/images/img.png" />
</head>
<body>
<input type="hidden" id="csrfToken" name="_csrf" value="{{token}}"/>
<!-- partial -->
<div class="container-fluid page-body-wrapper">
  <aside class="sidebar">
    <img src="/images/logo.png" alt="Logo" class="logo">
    <ul class="menu">
      <li class="active">
        <a href="/indexUser">
          <img src="/images/iconMenu/home2.png" alt="Home Icon"> Home
        </a>
      </li>
      <li>
        <a href="/iaReader">
          <img src="/images/iconMenu/iareader1.png" alt="IA Reader Icon"> IA's Reader
        </a>
      </li>
      <li>
        <a href="/journal">
          <img src="/images/iconMenu/journal1.png" alt="Journal Icon"> Reading Journal
        </a>
      </li>
      <li>
        <a href="/bookShelf">
          <img src="/images/iconMenu/bookshelf1.png" alt="Bookshelf Icon"> Bookshelf
        </a>
      </li>
      <li>
        <a href="/list">
          <img src="/images/iconMenu/list1.png" alt="Lists Icon"> Tus Listas
        </a>
      </li>
      <li>
        <a href="/friends">
          <img src="/images/iconMenu/friends1.png" alt="Friends Icon"> Amigos
        </a>
      </li>
      <li>
        <a href="/challenge">
          <img src="/images/iconMenu/challenge1.png" alt="Challenges Icon"> Challenges
        </a>
      </li>
      <li>
        <a href="/ranking">
          <img src="/images/iconMenu/ranking1.png" alt="Rankings Icon"> Rankings
        </a>
      </li>
      <li>
        <a href="/charts">
          <img src="/images/iconMenu/estadisticas1.png" alt="Stats Icon"> Tus Estadísticas
        </a>
      </li>
      <li>
        <a href="/profile">
          <img src="/images/iconMenu/profile1.png" alt="Profile Icon"> Perfil
        </a>
      </li>
    </ul>
    <a href="/logout" class="logout-link">
      Cerrar Sesión
      <div class="arrow-wrapper">
        <div class="arrow"></div>
      </div>
    </a>
  </aside>
  <!-- partial -->
  <div class="main-panel">
    <div class="content-wrapper">
      <div class="row">
        <div class="col-md-12 grid-margin">
          <div class="row">
            <div class="col-12 col-xl-8 mb-4 mb-xl-0">
              <h1 class="font-weight-bold">¡Bienvenido Reader!</h1>
            </div>

          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 grid-margin stretch-card">
          <div class="card tale-bg">
            <div class="card-people mt-auto">
              <img src="/images/homebanner.png" alt="banner">
            </div>
          </div>
        </div>
        <div class="col-md-6 grid-margin transparent">
          <div class="row">
            <div class="col-md-6 mb-4 stretch-card transparent">
              <div class="card card-tale">
                <div class="card-body">
                  <p class="mb-4">Total Amigos</p>
                  <p class="fs-30 mb-2">{{totFriends}}</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-4 stretch-card transparent">
              <div class="card card-dark-blue">
                <div class="card-body">
                  <p class="mb-4">Total Leidos</p>
                  <p class="fs-30 mb-2">{{totRead}}</p>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-4 mb-lg-0 stretch-card transparent">
              <div class="card card-light-blue">
                <div class="card-body">
                  <p class="mb-4">Challenges Superados</p>
                  <p class="fs-30 mb-2">{{totChallenges}}</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 stretch-card transparent">
              <div class="card card-light-danger">
                <div class="card-body">
                  <p class="mb-4">Total Páginas</p>
                  <p class="fs-30 mb-2">{{totPages}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-7 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <p class="card-title mb-0">Últimos detalles de tu lectura</p>
              <div class="table-responsive" >
                <table class="table table-striped table-borderless">
                  <thead>
                  <tr>
                    <th>Libro</th>
                    <th>Modificación</th>
                    <th>Estado</th>
                  </tr>
                  </thead>
                  <tbody>
                  {{#lastEvents}}
                  <tr>
                    <td>{{book.title}}</td>
                    <td>{{formattedDate}}</td>
                    <td class="font-weight-medium">
                      {{#reading}}
                      <div class="badge badge-warning">Leyendo</div>
                      {{/reading}}
                      {{#finished}}
                      <div class="badge badge-success">Leído</div>
                      {{/finished}}
                    </td>
                  </tr>
                  {{/lastEvents}}
                  {{^lastEvents}}
                  <tr>
                    <td colspan="3" class="text-center text-muted">Sin actividad reciente</td>
                  </tr>
                  {{/lastEvents}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-5 stretch-card grid-margin">
          <div class="card">
            <div class="card-body">
              <p class="card-title mb-0">Recomendaciones</p>
              <div class="table-responsive">
                <table class="table table-borderless">
                  <thead>
                  <tr>
                    <th class="border-bottom pb-2">Guardar</th>
                    <th class="ps-0  pb-2 border-bottom">Libro</th>
                    <th class="border-bottom pb-2">Puntuación</th>
                    <th class="border-bottom pb-2">Estrellas</th>
                  </tr>
                  </thead>
                  <tbody>
                  {{#recs}}
                  <tr>
                    <td>
                      <div class="heart-container" title="Like">
                        <input type="checkbox" class="checkbox" data-book-id="{{book.id}}" onchange="saveRecommendation(this)">
                        <div class="svg-container">
                          <svg viewBox="0 0 24 24" class="svg-outline" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Zm-3.585,18.4a2.973,2.973,0,0,1-3.83,0C4.947,16.006,2,11.87,2,8.967a4.8,4.8,0,0,1,4.5-5.05A4.8,4.8,0,0,1,11,8.967a1,1,0,0,0,2,0,4.8,4.8,0,0,1,4.5-5.05A4.8,4.8,0,0,1,22,8.967C22,11.87,19.053,16.006,13.915,20.313Z"></path>
                          </svg>
                          <svg viewBox="0 0 24 24" class="svg-filled" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5,1.917a6.4,6.4,0,0,0-5.5,3.3,6.4,6.4,0,0,0-5.5-3.3A6.8,6.8,0,0,0,0,8.967c0,4.547,4.786,9.513,8.8,12.88a4.974,4.974,0,0,0,6.4,0C19.214,18.48,24,13.514,24,8.967A6.8,6.8,0,0,0,17.5,1.917Z"></path>
                          </svg>
                          <svg class="svg-celebrate" width="100" height="100" xmlns="http://www.w3.org/2000/svg">
                            <polygon points="10,10 20,20"></polygon>
                            <polygon points="10,50 20,50"></polygon>
                            <polygon points="20,80 30,70"></polygon>
                            <polygon points="90,10 80,20"></polygon>
                            <polygon points="90,50 80,50"></polygon>
                            <polygon points="80,80 70,70"></polygon>
                          </svg>
                        </div>
                      </div>
                    </td>
                    <td class="ps-0">{{book.title}}</td>
                    <td>
                      <p class="mb-0"><span class="font-weight-bold me-2"></span>({{decimalRating}})</p>
                    </td>
                    <td class="text-muted" style="align-self: center">
                      {{#filledStars}}
                      <i class="fa fa-star" style="color: #ffcc00;"></i>
                      {{/filledStars}}
                      {{#emptyStars}}
                      <i class="fa fa-star-o" style="color: #ffcc00;"></i>
                      {{/emptyStars}}
                    </td>
                  </tr>
                  {{/recs}}
                  {{^recs}}
                    <tr><td colspan="4" class="text-center">No hay recomendaciones disponibles</td></tr>
                  {{/recs}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      <div class="row">
        <div class="col-md-4 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Próximas Lecturas</h4>
              <div class="list-wrapper pt-2">
                <ul class="d-flex flex-column-reverse todo-list todo-list-custom">
                  {{#wishlistEntries}}
                  <li>
                    <div class="form-check form-check-flat">
                      <label class="form-check-label">
                        <input class="checkbox" type="checkbox" checked> {{book.title}} </label>
                    </div>
                    <i class="remove ti-close" onclick="removeFromWishlist({{book.id}}, this)"></i>
                  </li>
                  {{/wishlistEntries}}
                  {{^wishlistEntries}}
                  <li class="text-center text-muted">No hay próximas lecturas</li>
                  {{/wishlistEntries}}
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 stretch-card grid-margin">
          <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">Leyendo</p>
                  <div class="charts-data">
                    {{#readingEntries}}
                    <div class="reading-entry">
                      <p>{{book.title}}</p>
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="progress progress-md flex-grow-1 me-4">
                          <div class="progress-bar bg-info"
                               style="width: {{progress}}%;"
                               role="progressbar"
                               aria-valuenow="{{progress}}"
                               aria-valuemin="0"
                               aria-valuemax="100">
                            {{progress}}%
                          </div>
                        </div>
                      </div>
                    </div>
                    {{/readingEntries}}
                    {{^readingEntries}}
                    <p>No hay libros en proceso de lectura.</p>
                    {{/readingEntries}}
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-12 stretch-card grid-margin grid-margin-md-0">
              <div class="card data-icon-card-primary">
                <div class="row">
                  <div class="card-people mt-auto">
                    <img src="/images/homebanner2.png" alt="banner">
                  </div>
                  <div class="col-4 background-icon">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 stretch-card grid-margin">
          <div class="card">
            <div class="card-body">
              <p class="card-title">Tus amigos</p>
              <ul class="icon-data-list" id="friendList">

              </ul>
            </div>
          </div>
        </div>
      </div>
    <!-- content-wrapper ends -->
    <!-- partial:partials/_footer.html -->

    <!-- partial -->
  </div>
      <footer class="footer">
        <div class="d-sm-flex justify-content-center justify-content-sm-between">
          <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2023.  <a href="https://www.bootstrapdash.com/" target="_blank">Bootstrap admin template</a> from BootstrapDash. All rights reserved.</span>
          <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Special Reads <i class="ti-heart text-danger ms-1"></i></span>
        </div>
      </footer>
  <!-- main-panel ends -->
</div>
<!-- page-body-wrapper ends -->
</div>
<script>
  const csrfToken = document.getElementById('csrfToken').value;

  function saveRecommendation(el) {
    const bookId = el.getAttribute('data-book-id');
    fetch('/indexUser/wishlist/add?bookId=' + bookId, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'X-CSRF-TOKEN': csrfToken
      }
    })
            .then(res => {
              if (!res.ok) throw new Error('Error guardando el libro');
              // recarga la página (o actualiza sólo la lista)
              location.reload();
            })
            .catch(console.error);
  }

  function removeFromWishlist(bookId, btn) {
    fetch('/indexUser/wishlist/remove?bookId=' + bookId, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'X-CSRF-TOKEN': csrfToken
      }
    })
            .then(res => {
              if (!res.ok) throw new Error('Error eliminando el libro');
              btn.closest('li').remove();
            })
            .catch(console.error);
  }
  async function loadAcceptedFriends() {
    try {
      const response = await fetch('/api/friends/accept', {
        method: 'GET',
        credentials: 'include'
      });
      if (!response.ok) {
        throw new Error('Error al cargar tus amigos');
      }
      const friends = await response.json();
      const ul = document.getElementById('friendList');
      ul.innerHTML = ''; // Limpiar contenido previo

      friends.forEach(friend => {
        // Creamos <li>
        const li = document.createElement('li');

        // Estructura principal: <div class="d-flex"> dentro del <li>
        const containerDiv = document.createElement('div');
        containerDiv.classList.add('d-flex');

        // Imagen: Usar la URL real, o si no existe, una imagen por defecto
        const img = document.createElement('img');
        // Si profilePhotoUrl existe lo usamos, de lo contrario se usa un valor por defecto
        img.src = friend.profilePhotoUrl ? friend.profilePhotoUrl : "/images/iconoPerfil.png";
        img.alt = friend.friendName;

        // Div con la info
        const infoDiv = document.createElement('div');

        // Nombre del amigo
        const pName = document.createElement('p');
        pName.classList.add('text-info', 'mb-1');
        pName.textContent = friend.friendName;

        // Libro que está leyendo
        const pBook = document.createElement('p');
        pBook.classList.add('mb-0');
        pBook.textContent = friend.bookTitle;

        // Contenedor de la barra de progreso
        const progressContainer = document.createElement('div');
        progressContainer.classList.add('d-flex', 'justify-content-between', 'align-items-center');

        // Outer progress
        const progressOuter = document.createElement('div');
        progressOuter.classList.add('progress', 'progress-md', 'flex-grow-1', 'me-4');

        // Barra de progreso
        const progressBar = document.createElement('div');
        progressBar.classList.add('progress-bar', 'bg-info');
        progressBar.style.width = friend.progress + '%';
        progressBar.setAttribute('role', 'progressbar');
        progressBar.setAttribute('aria-valuenow', friend.progress);
        progressBar.setAttribute('aria-valuemin', 0);
        progressBar.setAttribute('aria-valuemax', 100);
        // Centrar el texto dentro de la barra (asegúrate que tu CSS tenga display: flex, etc.)
        progressBar.textContent = friend.progress + '%';

        progressOuter.appendChild(progressBar);

        // Texto con el valor del progreso a la derecha (opcional)
        const pProgress = document.createElement('p');
        pProgress.classList.add('mb-0');
        pProgress.textContent = friend.progress + '%';

        progressContainer.appendChild(progressOuter);
        progressContainer.appendChild(pProgress);

        // Agregar elementos al infoDiv
        infoDiv.appendChild(pName);
        infoDiv.appendChild(pBook);
        infoDiv.appendChild(progressContainer);

        // Agregar la imagen y la info al contenedor principal
        containerDiv.appendChild(img);
        containerDiv.appendChild(infoDiv);

        li.appendChild(containerDiv);
        ul.appendChild(li);
      });
    } catch (error) {
      console.error("Error al cargar amigos aceptados:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", loadAcceptedFriends);
</script>
<script src="assets/vendors/js/vendor.bundle.base.js"></script>

<script src="assets/vendors/chart.js/chart.umd.js"></script>
<script src="assets/vendors/datatables.net/jquery.dataTables.js"></script>
<script src="assets/vendors/datatables.net-bs5/dataTables.bootstrap5.js"></script>
<script src="assets/js/dataTables.select.min.js"></script>

<script src="assets/js/off-canvas.js"></script>
<script src="assets/js/template.js"></script>
<script src="assets/js/settings.js"></script>
<script src="assets/js/todolist.js"></script>

<script src="assets/js/jquery.cookie.js" type="text/javascript"></script>
<script src="assets/js/dashboard.js"></script>

</body>
</html>